<html>
<head>
  <title></title>
</head>

<style>
#img {
  position: absolute;
  top: 0;
  left: 0;
  margin: 0 0 0 0;
  border: none;
  padding: 0 0 0 0;
}

.barH {
  position: absolute;
  top: 0;
  left: 0;
  margin: 0 0 0 0;
  border: none;
  padding: 0 0 0 0;
  height: 1px;
  background: green;
  opacity: 0.3;
}

.barV {
  position: absolute;
  top: 0;
  left: 0;
  margin: 0 0 0 0;
  border: none;
  padding: 0 0 0 0;
  width: 1px;
  background: green;
  opacity: 0.3;
}

#msg {
  position: fixed;
  bottom: 0;
  left: 0;
  margin: 0 0 0 0;
  padding: 3px 10px;
  z-index: 1;
  color: #888;
  font-size: 8pt;
}

.hit {
  background-color: #dfd;
}
</style>

<body>
  <img id="img" src="out-000.png">
  <div id="barHL" class="barH"></div>
  <div id="barHR" class="barH"></div>
  <div id="barVT" class="barV"></div>
  <div id="barVB" class="barV"></div>
  <div id="msg">loading...</div>
</body>

<script>
window.onload = function() {
  fetch('out.json')
    .then(function(response) {
      return response.json();
    })
    .then(function(info) {
      main(info);
    });
}

var mainInfo;

function main(info) {
  mainInfo = info;

  var rankToPattern = [];
  for (var k in info.pattern_ranks) {
    rankToPattern[info.pattern_ranks[k]] = k;
  }

  var barHLEl = document.getElementById("barHL");
  var barHREl = document.getElementById("barHR");
  var barVTEl = document.getElementById("barVT");
  var barVBEl = document.getElementById("barVB");

  var imgEl = document.getElementById("img");
  var msgEl = document.getElementById("msg");

  var canvasEl;
  var canvasCtx;

  var startSecondsSince2010;

  var focused = false;

  imgEl.addEventListener("click", onClick, false)

  imgEl.addEventListener("mousemove", onMouseMove, false)

  imgEl.addEventListener("dblclick", onDblClick, false)

  function onClick(e) {
    focused = !focused;

    locationUpdate(e)
  }

  function onMouseMove(e) {
    locationUpdate(e);
  }

  function onDblClick(e) {
    focused = true;

    var url = "/logan-drill?start=" + formatDate(eventDate(e));

    var filePatt = filePatternAtX(e.offsetX);
    if (filePatt) {
      terms = filePatt[1].replace(/#[a-z][a-z0-9]+\s?/g, '');
      terms = terms.trim();
      terms = terms.replace(/\s+/g, ',');
      terms = terms.replace(/'/g, '');

      url = url + "&terms=" + terms
    }

    window.open(url);
  }

  function locationUpdate(e) {
    var file;
    var patt;

    prepCanvasData();

    if (!focused) {
      var msg = formatDate(eventDate(e)) + "<br>";

      var filePatt = filePatternAtX(e.offsetX);
      if (filePatt) {
        msg += filePatt[0] + "<br>" + filePatt[1];
      }

      msg = msg.substring(0, 400);

      msgEl.innerHTML = msg;

      var rgb = canvasCtx.getImageData(e.offsetX, e.offsetY, 1, 1).data;
      if (rgb[0] >= 255 && rgb[1] >= 255 && rgb[2] >= 255) {
        msgEl.className = "hit";
      } else {
        msgEl.className = "";
      }

      barHLEl.style.width = (e.offsetX - 3) + "px";
      barHLEl.style.top = e.offsetY + "px";

      barHREl.style.left = (e.offsetX + 3) + "px";
      barHREl.style.width = (canvasEl.width - e.offsetX - 3) + "px";
      barHREl.style.top = e.offsetY + "px";

      barVTEl.style.height = (e.offsetY - 3) + "px";
      barVTEl.style.left = e.offsetX + "px";

      barVBEl.style.top = (e.offsetY + 3) + "px";
      barVBEl.style.height = (canvasEl.height - e.offsetY - 3) + "px";
      barVBEl.style.left = e.offsetX + "px";
    }

    return patt;
  }

  function filePatternAtX(offsetX) {
    var rank = offsetX - info.timestamp_gutter_width;
    if (rank >= 0) {
      rank = rank % (rankToPattern.length + 1);

      var v = rankToPattern[rank];
      if (v) {
        var c = v.indexOf(':');
        if (c > 0) {
          var file = v.substring(0, c);
          var patt = v.substring(c + 1);

          patt = patt.replace(/\d+>/g, '');
          patt = patt.replace(/', '/g, ' ');
          patt = patt.replace(/[[\]]/g, '');

          return [file, patt];
        }
      }
    }
  }

  function prepCanvasData() {
    if (!canvasEl) {
      canvasEl = document.createElement("canvas");
      canvasEl.width = imgEl.width;
      canvasEl.height = imgEl.height;

      canvasCtx = canvasEl.getContext('2d');
      canvasCtx.drawImage(imgEl, 0, 0, imgEl.width, imgEl.height);

      startSecondsSince2010 =
        rgbToInt(canvasCtx.getImageData(0, 0, 1, 1).data) * 60;

      console.log("start timestamp",
                  new Date(2010, 0, 1, 0, 0, startSecondsSince2010))
    }
  }

  function eventDate(e) {
    return new Date(2010, 0, 1, 0, 0,
                    startSecondsSince2010 +
                    rgbToInt(canvasCtx.getImageData(0, e.offsetY, 1, 1).data));
  }

  function rgbToInt(rgb) {
    return (rgb[0] << 16) + (rgb[1] << 8) + rgb[2];
  }

  function formatDate(d) {
    return d.getFullYear() + "-" +
      zeroPad(1 + d.getMonth(), 2) + "-" +
      zeroPad(d.getDate(), 2) + "T" +
      zeroPad(d.getHours(), 2) + ":" +
      zeroPad(d.getMinutes(), 2) + ":" +
      zeroPad(d.getSeconds(), 2)
  }

  var zeros = "0000000000";

  function zeroPad(s, nchars) {
    s = String(s)
    return zeros.substring(0, nchars - s.length) + s
  }
}
</script>
</html>
