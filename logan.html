<html>
<head>
  <title></title>
</head>

<style>
#img {
  position: absolute;
  top: 0;
  left: 0;
  margin: 0 0 0 0;
  border: none;
  padding: 0 0 0 0;
}

#bar {
  position: absolute;
  top: 0;
  left: 0;
  margin: 0 0 0 0;
  border: none;
  padding: 0 0 0 0;
  height: 1px;
  background: green;
  opacity: 0.3;
}

#msg {
  position: fixed;
  left: 5px;
  bottom: 0;
  z-index: 100;
  color: #888;
}
</style>

<body>
  <img id="img" src="out-000.png">
  <div id="bar"></div>
  <pre id="msg"></pre>
</body>

<script>
window.onload = function() {
  var barEl = document.getElementById("bar");
  var imgEl = document.getElementById("img");
  var msgEl = document.getElementById("msg");

  var canvasEl;
  var canvasCtx;

  var startSecondsSince2010;

  imgEl.addEventListener("dblclick", onDblClick, false)

  imgEl.addEventListener("mousemove", onMouseMove, false)

  function onDblClick(e) {
    var d = eventDate(e);

    console.log(d);

    window.open("/logan-drill?d=" + formatDate(d), "logan-drill")
  }

  function onMouseMove(e) {
    var d = eventDate(e);

    // Output YYYY-MM-DDTHH:MM:SS.
    msgEl.innerHTML = formatDate(d);
  }

  function eventDate(e) {
    if (!canvasEl) {
      canvasEl = document.createElement("canvas");
      canvasEl.width = imgEl.width;
      canvasEl.height = imgEl.height;

      canvasCtx = canvasEl.getContext('2d');
      canvasCtx.drawImage(imgEl, 0, 0, imgEl.width, imgEl.height);

      startSecondsSince2010 =
        pixelToInt(canvasCtx.getImageData(0, 0, 1, 1).data) * 60;

      barEl.style.width = canvasEl.width + "px";
    }

    barEl.style.top = e.offsetY + "px";

    return new Date(2010, 0, 0, 0, 0,
                    startSecondsSince2010 +
                    pixelToInt(canvasCtx.getImageData(0, e.offsetY, 1, 1).data));
  }

  function pixelToInt(pixel) {
    return (pixel[0] << 16) + (pixel[1] << 8) + pixel[2];
  }

  function formatDate(d) {
    return d.getFullYear() + "-" +
      zeroPad(1 + d.getMonth(), 2) + "-" +
      zeroPad(d.getDate(), 2) + "T" +
      zeroPad(d.getHours(), 2) + ":" +
      zeroPad(d.getMinutes(), 2) + ":" +
      zeroPad(d.getSeconds(), 2)
  }

  var zeros = "0000000000";

  function zeroPad(s, nchars) {
    s = String(s)
    return zeros.substring(0, nchars - s.length) + s
  }
}
</script>
</html>
