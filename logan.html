<html>
<head>
  <title></title>
</head>

<style>
#img, #hilite {
  position: absolute;
  top: 0;
  left: 0;
  margin: 0 0 0 0;
  border: none;
}

#img {
  padding: 0 0 80px 0;
}

.barH {
  position: absolute;
  top: 0;
  left: 0;
  margin: 0 0 0 0;
  border: none;
  padding: 0 0 0 0;
  height: 1px;
  background: blue;
  opacity: 0.5;
}

.barV {
  position: absolute;
  top: 0;
  left: 0;
  margin: 0 0 0 0;
  border: none;
  padding: 0 0 0 0;
  width: 1px;
  background: blue;
  opacity: 0.5;
}

.hit {
  background-color: #dfd;
}

#ftr {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  margin: 0 0 0 0;
  padding: 3px 10px;
  z-index: 1;
  font-size: 8pt;
  color: #888;
}

#ftr .rhs {
  float: right;
  margin-right: 20px;
  visibility: hidden;
}

#ftr .rhs button {
  margin-bottom: 5px;
}

#ftr .hit .rhs {
  visibility: visible;
}

.hilite {
  white-space: nowrap;
}

#hiliteInput {
  width: 50%;
  margin-top: 5px;
  background-color: #eee;
}
</style>

<body>
  <img id="img" src="out-000.png">
  <div id="barHL" class="barH"></div>
  <div id="barHR" class="barH"></div>
  <div id="barVT" class="barV"></div>
  <div id="barVB" class="barV"></div>
  <div id="ftr">
    <div class="rhs">
      <button onclick="drill();">drill &gt;&gt;</button><br/>
    </div>
    <div id="msg">loading...</div>
    <div class="hilite">
      <button onclick="hilite();">hilite</button>
      <input type="text" id="hiliteInput"/>
    </div>
  </div>
</body>

<script>
window.onload = function() {
  fetch('out.json')
    .then(function(response) {
      return response.json();
    })
    .then(function(info) {
      main(info);
    });
}

var mainInfo;
var mainRankToPattern;

function main(info) {
  mainInfo = info;

  var rankToPattern = [];
  for (var k in info.pattern_ranks) {
    rankToPattern[info.pattern_ranks[k]] = k;
  }

  mainRankToPattern = rankToPattern;

  var barHLEl = document.getElementById("barHL");
  var barHREl = document.getElementById("barHR");
  var barVTEl = document.getElementById("barVT");
  var barVBEl = document.getElementById("barVB");

  var imgEl = document.getElementById("img");
  var msgEl = document.getElementById("msg");
  var ftrEl = document.getElementById("ftr");

  var canvasEl;
  var canvasCtx;

  var hiliteEl;
  var hiliteCtx;

  var startSecondsSince2010;

  var focused = false;

  imgEl.addEventListener("click", onClick, false)
  imgEl.addEventListener("mousemove", onMouseMove, false)
  imgEl.addEventListener("dblclick", onDblClick, false)

  function onClick(e) {
    focused = !focused;

    locationUpdate(e)
  }

  function onMouseMove(e) {
    locationUpdate(e);
  }

  var locationLast;

  function onDblClick(e) {
    drill(locationLast);
  }

  function locationUpdate(e) {
    if (canvasEl && canvasEl.height < e.offsetY) {
      return;
    }

    locationLast = e;

    var file;
    var patt;

    prepCanvas();

    if (!focused) {
      var msg = formatDate(eventDate(e)) + "<br>";

      var filePatt = filePatternAtX(e.offsetX);
      if (filePatt) {
        msg += filePatt[0] + "<br>" + filePatt[1];
      }

      msg = msg.substring(0, 400);

      msgEl.innerHTML = msg;

      var rgb = canvasCtx.getImageData(e.offsetX, e.offsetY, 1, 1).data;
      if (rgb[0] >= 255 && rgb[1] >= 255 && rgb[2] >= 255) {
        ftrEl.className = "hit";
      } else {
        ftrEl.className = "";
      }

      barHLEl.style.width = (e.offsetX - 3) + "px";
      barHLEl.style.top = e.offsetY + "px";

      barHREl.style.left = (e.offsetX + 3) + "px";
      barHREl.style.width = (canvasEl.width - e.offsetX - 3) + "px";
      barHREl.style.top = e.offsetY + "px";

      barVTEl.style.height = (e.offsetY - 3) + "px";
      barVTEl.style.left = e.offsetX + "px";

      barVBEl.style.top = (e.offsetY + 3) + "px";
      barVBEl.style.height = (canvasEl.height - e.offsetY - 3) + "px";
      barVBEl.style.left = e.offsetX + "px";
    }

    return patt;
  }

  function prepCanvas() {
    if (!canvasEl) {
      canvasEl = document.createElement("canvas");
      canvasEl.width = imgEl.width;
      canvasEl.height = imgEl.height;

      canvasCtx = canvasEl.getContext('2d');
      canvasCtx.drawImage(imgEl, 0, 0, imgEl.width, imgEl.height);

      startSecondsSince2010 =
        rgbToInt(canvasCtx.getImageData(0, 0, 1, 1).data) * 60;

      console.log("start timestamp",
                  new Date(2010, 0, 1, 0, 0, startSecondsSince2010))

      hiliteEl = document.createElement("canvas");
      hiliteEl.id = "hilite";
      hiliteEl.width = imgEl.width;
      hiliteEl.height = imgEl.height;

      hiliteEl.addEventListener("click", onClick, false)
      hiliteEl.addEventListener("mousemove", onMouseMove, false)
      hiliteEl.addEventListener("dblclick", onDblClick, false)

      imgEl.parentElement.insertBefore(hiliteEl, imgEl.nextSibling);

      hiliteCtx = hiliteEl.getContext('2d');
    }
  }

  function filePatternAtX(offsetX) {
    var rank = offsetX - info.timestamp_gutter_width;
    if (rank >= 0) {
      rank = rank % (rankToPattern.length + 1);

      var v = rankToPattern[rank];
      if (v) {
        var c = v.indexOf(':');
        if (c > 0) {
          var file = v.substring(0, c);
          var patt = v.substring(c + 1);

          patt = patt.replace(/\d+>/g, '');
          patt = patt.replace(/', '/g, ' ');
          patt = patt.replace(/[[\]]/g, '');

          return [file, patt];
        }
      }
    }
  }

  function drill(e) {
    e = e || locationLast;
    if (!e) {
      return;
    }

    focused = true;

    var url = "/logan-drill?max_entries=1000&start=" + formatDate(eventDate(e));

    var filePatt = filePatternAtX(e.offsetX);
    if (filePatt) {
      terms = filePatt[1].replace(/#[a-z][a-z0-9]+\s?/g, '');
      terms = terms.trim();
      terms = terms.replace(/\s+/g, ',');
      terms = terms.replace(/'/g, '');

      url = url + "&terms=" + terms
    }

    window.open(url);
  }

  window.drill = drill;

  function eventDate(e) {
    return new Date(2010, 0, 1, 0, 0,
                    startSecondsSince2010 +
                    rgbToInt(canvasCtx.getImageData(0, e.offsetY, 1, 1).data));
  }

  document.getElementById("hiliteInput").addEventListener("keyup",
    function(e) {
      if (e.keyCode === 13) {
        e.preventDefault();
        hilite();
      }
    });

  function hilite(terms) {
    hiliteCtx.clearRect(0, 0, hiliteEl.width, hiliteEl.height);

    if (!terms) {
      var s = document.getElementById("hiliteInput").value.trim();
      if (s.length <= 0) {
        return;
      }

      terms = s.split(" ");
    }

    if (!mainInfo || terms.length <= 0) {
      return;
    }

    for (var rank in rankToPattern) {
      var pattern = rankToPattern[rank];

      var s = 0;
      for (var i in terms) {
        if (pattern.indexOf(terms[i]) >= 0) {
          s += 1;
        }
      }

      if (s > 0) {
        var c = 50 + Math.round(200.0 * (s / terms.length));
        var rgb = "rgb(" + c + "," + c + ",0,0.4)";
        hiliteCtx.fillStyle = rgb;
        hiliteCtx.fillRect(parseInt(rank) + info.timestamp_gutter_width, 0,
                           1, hiliteEl.height);
      }
    }
  }

  window.hilite = hilite;

  function rgbToInt(rgb) {
    return (rgb[0] << 16) + (rgb[1] << 8) + rgb[2];
  }

  function formatDate(d) {
    return d.getFullYear() + "-" +
      zeroPad(1 + d.getMonth(), 2) + "-" +
      zeroPad(d.getDate(), 2) + "T" +
      zeroPad(d.getHours(), 2) + ":" +
      zeroPad(d.getMinutes(), 2) + ":" +
      zeroPad(d.getSeconds(), 2)
  }

  var zeros = "0000000000";

  function zeroPad(s, nchars) {
    s = String(s)
    return zeros.substring(0, nchars - s.length) + s
  }
}
</script>
</html>
